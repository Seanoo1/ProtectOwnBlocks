package youtube.yomisyuram.protectownblocks;

import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.block.BlockState;
import org.bukkit.block.data.type.TNT;
import org.bukkit.entity.Player;
import org.bukkit.entity.TNTPrimed;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockBreakEvent;
import org.bukkit.projectiles.BlockProjectileSource;

public class ProtectExploit implements Listener {
    private final BlockDataStorage blockDataStorage;

    public ProtectExploit(BlockDataStorage blockDataStorage) {
        this.blockDataStorage = blockDataStorage;
    }
/*
    @EventHandler
    public void onBlockBreak(BlockBreakEvent event) {
        Block block = event.getBlock();
        Location blockLocation = block.getLocation();

        // 보호된 블록인지 확인
        if (blockDataStorage.isRestrictedBlock(blockLocation)) {
            // TNT 폭발에 의한 블록 파괴 취소
            if (isTNTExplosion(event)) {
                event.setCancelled(true);
                return;
            }

            Player player = event.getPlayer();
            if (!player.hasPermission("protectownblocks.bypass")) {
                if (!blockDataStorage.isBlockOwner(blockLocation, player.getUniqueId())) {
                    event.setCancelled(true);
                    player.sendMessage("이 블록을 파괴할 권한이 없습니다.");
                } else {
                    blockDataStorage.removeRestrictedBlock(blockLocation, player.getUniqueId());
                }
            }
        }
    }

    private boolean isTNTExplosion(BlockBreakEvent event) {
        Block block = event.getBlock();
        BlockState blockState = block.getState();
        if (blockState instanceof TNT) {
            TNTPrimed tnt = (TNTPrimed) blockState;
            if (tnt.getSource() instanceof BlockProjectileSource) {
                BlockProjectileSource source = (BlockProjectileSource) tnt.getSource();
                if (source.getBlock().getType() == Material.TNT) {
                    return true;
                }
            }
        }
        return false;
    }*/

}
